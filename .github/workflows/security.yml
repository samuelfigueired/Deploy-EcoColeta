name: ðŸ”’ Security & Dependencies Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'EcoColetaPrograma/ecoColeta-Presentation/package.json'
      - 'EcoColetaPrograma/ecoColeta-Presentation/package-lock.json'

env:
  NODE_VERSION: '18.x'

jobs:
  # Job para auditoria de seguranÃ§a
  security-audit:
    name: ðŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'EcoColetaPrograma/ecoColeta-Presentation/package.json'
        
    - name: ðŸ“¦ Install dependencies
      working-directory: ./EcoColetaPrograma/ecoColeta-Presentation
      run: npm ci
      
    - name: ðŸ”’ Run npm audit
      working-directory: ./EcoColetaPrograma/ecoColeta-Presentation
      run: |
        echo "Running security audit..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        
        # Parse and display results
        if [ -s audit-results.json ]; then
          echo "ðŸ” Security audit results:"
          cat audit-results.json | jq -r '.metadata | "Total vulnerabilities: \(.vulnerabilities.total)"'
          cat audit-results.json | jq -r '.metadata | "Critical: \(.vulnerabilities.critical)"'
          cat audit-results.json | jq -r '.metadata | "High: \(.vulnerabilities.high)"'
          cat audit-results.json | jq -r '.metadata | "Moderate: \(.vulnerabilities.moderate)"'
          cat audit-results.json | jq -r '.metadata | "Low: \(.vulnerabilities.low)"'
          
          # Fail if critical or high vulnerabilities found
          CRITICAL=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.high // 0')
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical or high vulnerabilities found!"
            echo "Please run 'npm audit fix' to resolve them."
            exit 1
          else
            echo "âœ… No critical or high vulnerabilities found!"
          fi
        else
          echo "âœ… No vulnerabilities found!"
        fi

  # Job para verificar dependÃªncias desatualizadas
  dependency-check:
    name: ðŸ“¦ Dependencies Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'EcoColetaPrograma/ecoColeta-Presentation/package.json'
        
    - name: ðŸ“¦ Check outdated packages
      working-directory: ./EcoColetaPrograma/ecoColeta-Presentation
      run: |
        echo "Checking for outdated packages..."
        npm outdated --json > outdated.json || true
        
        if [ -s outdated.json ]; then
          echo "ðŸ“‹ Outdated packages found:"
          cat outdated.json | jq -r 'to_entries[] | "\(.key): \(.value.current) â†’ \(.value.latest)"'
          
          # Count outdated packages
          OUTDATED_COUNT=$(cat outdated.json | jq 'length')
          echo "ðŸ“Š Total outdated packages: $OUTDATED_COUNT"
          
          if [ "$OUTDATED_COUNT" -gt 10 ]; then
            echo "âš ï¸ Many packages are outdated. Consider updating them."
          fi
        else
          echo "âœ… All packages are up to date!"
        fi
        
    - name: ðŸ“Š Analyze package.json
      working-directory: ./EcoColetaPrograma/ecoColeta-Presentation
      run: |
        echo "ðŸ“Š Package analysis:"
        echo "Dependencies: $(cat package.json | jq '.dependencies | length')"
        echo "DevDependencies: $(cat package.json | jq '.devDependencies | length // 0')"
        
        # Check for common security packages
        if cat package.json | jq -e '.dependencies | has("helmet")' > /dev/null; then
          echo "âœ… Security headers package (helmet) is installed"
        else
          echo "âš ï¸ Consider adding helmet for security headers"
        fi
        
        if cat package.json | jq -e '.dependencies | has("express-rate-limit")' > /dev/null; then
          echo "âœ… Rate limiting package is installed"
        else
          echo "âš ï¸ Consider adding express-rate-limit for API protection"
        fi

  # Job para verificar licenÃ§as
  license-check:
    name: ðŸ“„ License Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'EcoColetaPrograma/ecoColeta-Presentation/package.json'
        
    - name: ðŸ“¦ Install license checker
      run: npm install -g license-checker
      
    - name: ðŸ“„ Check licenses
      working-directory: ./EcoColetaPrograma/ecoColeta-Presentation
      run: |
        echo "Checking package licenses..."
        license-checker --summary > license-summary.txt
        cat license-summary.txt
        
        # Check for problematic licenses
        PROBLEMATIC_LICENSES="GPL-3.0,AGPL-3.0,LGPL-3.0"
        
        if license-checker --failOn "$PROBLEMATIC_LICENSES" --onlyAllow "MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;CC0-1.0;Unlicense" > /dev/null 2>&1; then
          echo "âœ… All licenses are compatible"
        else
          echo "âš ï¸ Some packages may have license compatibility issues"
          echo "Please review the license summary above"
        fi

  # Job para gerar relatÃ³rio de seguranÃ§a
  security-report:
    name: ðŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, license-check]
    if: always()
    
    steps:
    - name: ðŸ“Š Create security report
      run: |
        cat > security-report.md << EOF
        # ðŸ”’ EcoColeta Security Report
        
        **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        **Workflow:** ${{ github.workflow }}
        **Run:** ${{ github.run_number }}
        
        ## ðŸ“‹ Summary
        
        - Security Audit: ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        - Dependencies Check: ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        - License Check: ${{ needs.license-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        
        ## ðŸ›¡ï¸ Security Status
        
        ${{ needs.security-audit.result == 'success' && 'No critical vulnerabilities detected.' || 'Security issues require attention.' }}
        
        ## ðŸ“¦ Dependencies Status
        
        ${{ needs.dependency-check.result == 'success' && 'Dependencies are properly managed.' || 'Some dependencies may need updates.' }}
        
        ## ðŸ“„ License Compliance
        
        ${{ needs.license-check.result == 'success' && 'All licenses are compatible.' || 'License review may be required.' }}
        
        ## ðŸ”§ Recommendations
        
        - Run \`npm audit fix\` to resolve any security issues
        - Update outdated packages regularly
        - Review dependency licenses for compliance
        - Consider adding security middleware (helmet, rate limiting)
        
        ---
        *This report is automatically generated by EcoColeta CI/CD pipeline ðŸ¤–*
        EOF
        
        echo "Security report generated successfully!"
        cat security-report.md
        
    - name: ðŸ“ Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report-${{ github.run_number }}
        path: security-report.md
        retention-days: 30

  # Job para notificar sobre problemas de seguranÃ§a
  notify-security:
    name: ðŸ“¢ Security Notifications
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, license-check]
    if: failure()
    
    steps:
    - name: ðŸš¨ Security alert
      run: |
        echo "ðŸš¨ SECURITY ALERT: EcoColeta Security Check Failed!"
        echo "ðŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "Please review the security issues and take appropriate action."
        echo "Security is crucial for protecting user data and maintaining trust."
        echo ""
        echo "ðŸŒ± Remember: A secure EcoColeta helps protect both data and the environment!"
